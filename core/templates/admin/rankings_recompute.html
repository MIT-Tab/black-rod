{% extends "base/base.html" %}
{% block content %}
    <div class="container mt-5">
        <div class="card rankings-card">
            <div class="card-body">
                <h5 class="card-title">
                    <i class="fas fa-calculator mr-2"></i>Rankings Recompute Tool
                </h5>
                <div class="alert alert-warning rankings-warning" role="alert">
                    <strong><i class="fas fa-exclamation-triangle mr-2"></i>Warning:</strong>
                    Recomputation can be difficult to reverse. Use only if necessary.
                </div>
                <form id="recomputeForm">
                    {% csrf_token %}
                    <div class="form-row">
                        <div class="col-md-6">
                            <label for="season" class="font-weight-bold">Season</label>
                            <select class="form-control" id="season" name="season" required>
                                <option value="">Select a season...</option>
                                {% for season_key, season_display in seasons %}
                                    <option value="{{ season_key }}">{{ season_display }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="ranking_type" class="font-weight-bold">Ranking Type</label>
                            <select class="form-control" id="ranking_type" name="ranking_type" required>
                                <option value="">Select a ranking type...</option>
                                {% for type_key, type_display in ranking_types %}
                                    <option value="{{ type_key }}">{{ type_display }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    <div class="mt-3">
                        <button type="submit" class="btn btn-primary" id="recomputeBtn">
                            <i class="fas fa-play mr-2"></i>Start Recomputation
                        </button>
                        <a href="{% url 'core:admin_tools' %}" class="btn btn-secondary ml-2">
                            <i class="fas fa-arrow-left mr-2"></i>Back
                        </a>
                    </div>
                </form>
                <div id="progressSection" class="mt-4" style="display: none;">
                    <h6>
                        <i class="fas fa-cog fa-spin mr-2"></i>Processing...
                    </h6>
                    <div class="progress">
                        <div class="progress-bar progress-bar-striped progress-bar-animated"
                             style="width: 0%">0%</div>
                    </div>
                </div>
                <div id="resultsSection" class="mt-4" style="display: none;"></div>
            </div>
        </div>
    </div>
    <script>
        document.getElementById('recomputeForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const season = document.getElementById('season').value;
            const rankingType = document.getElementById('ranking_type').value;
            
            if (!season || !rankingType) {
                alert('Please select both a season and ranking type.');
                return;
            }
            
            if (rankingType === 'noty' && parseInt(season) > 2020) {
                alert('NOTY rankings are only available for the 2019-2020 season and earlier.');
                return;
            }
            
            const btn = document.getElementById('recomputeBtn');
            const progressSection = document.getElementById('progressSection');
            const resultsSection = document.getElementById('resultsSection');
            const progressBar = document.querySelector('.progress-bar');
            
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Processing...';
            progressSection.style.display = 'block';
            resultsSection.style.display = 'none';
            
            let progress = 0;
            const interval = setInterval(() => {
                progress += Math.random() * 15;
                if (progress > 90) progress = 90;
                progressBar.style.width = progress + '%';
                progressBar.textContent = Math.round(progress) + '%';
            }, 500);
            
            fetch('{% url "core:rankings_recompute" %}', {
                method: 'POST',
                body: new FormData(this),
                headers: { 'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value }
            })
            .then(response => response.json())
            .then(data => {
                clearInterval(interval);
                progressBar.style.width = '100%';
                progressBar.textContent = '100%';
                
                setTimeout(() => {
                    progressSection.style.display = 'none';
                    resultsSection.style.display = 'block';
                    const alertClass = data.success ? 'success' : 'danger';
                    const icon = data.success ? 'check-circle' : 'exclamation-circle';
                    resultsSection.innerHTML = `
                        <div class="alert alert-${alertClass}">
                            <i class="fas fa-${icon} mr-2"></i>${data.success ? data.message : data.error}
                        </div>
                    `;
                    btn.disabled = false;
                    btn.innerHTML = '<i class="fas fa-play mr-2"></i>Start Recomputation';
                }, 1000);
            })
            .catch(() => {
                clearInterval(interval);
                progressSection.style.display = 'none';
                resultsSection.style.display = 'block';
                resultsSection.innerHTML = '<div class="alert alert-danger"><i class="fas fa-exclamation-circle mr-2"></i>Failed to connect to server. Please try again.</div>';
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-play mr-2"></i>Start Recomputation';
            });
        });
    </script>
{% endblock content %}
